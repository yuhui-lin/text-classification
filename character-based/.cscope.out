cscope 15 $HOME/project/yuhui-cnn-character/character-based -q 0000000801 0000043137
	@cnn_character/__init__.py

	@cnn_character/eval.py

2 
äom
 
__futu»__
 
impÜt
 
absŞu‹_impÜt


3 
äom
 
__futu»__
 
impÜt
 
divisiÚ


4 
äom
 
__futu»__
 
impÜt
 
´št_funùiÚ


6 
äom
 
d©‘ime
 
impÜt
 datetime

7 
impÜt
 
m©h


8 
impÜt
 
time


9 
impÜt
 
os


11 
impÜt
 
numpy
 
as
 
Å


12 
impÜt
 
‹nsÜæow
 
as
 
tf


14 
äom
 
ún_ch¬aù”
 
impÜt
 
mod–


16 
	gFLAGS
 = 
tf
.
­p
.
æags
.
FLAGS


18 
tf
.
­p
.
æags
.
DEFINE_¡ršg
('train_dir', 'outputs/',

20 
	gtf
.
	g­p
.
	gæags
.
DEFINE_š‹g”
('eval_interval_secs', 60 * 5,

22 
	gtf
.
	g­p
.
	gæags
.
DEFINE_š‹g”
('batch_size', 128,

24 
	gtf
.
	g­p
.
	gæags
.
DEFINE_boŞ—n
('run_Úû', 
F®£
,

27 
	gtf
.
	g­p
.
	gæags
.
DEFINE_æßt
("dropout_keep_prob", 1,

30 #glogb® 
·¿m‘”s


32 
	gCHECKPOINT_DIR
 = 
os
.
·th
.
još
(
FLAGS
.
Œaš_dœ
, "checkpoints")

33 
	gEVAL_DIR
 = 
os
.
·th
.
još
(
FLAGS
.
Œaš_dœ
, "ev®-" + 
¡r
((
time
.
	$time
())))

38 
def
 
	$ev®_Úû
(
§v”
, 
summ¬y_wr™”
, 
tİ_k_İ
, 
summ¬y_İ
):

40 
Args
:

41 
§v”
: 
Sav”
.

42 
summ¬y_wr™”
: 
Summ¬y
 
wr™”
.

43 
tİ_k_İ
: 
Tİ
 
K
 
İ
.

44 
summ¬y_İ
: 
Summ¬y
 
İ
.

46 
w™h
 
tf
.
	$SessiÚ
(è
as
 
£ss
:

47 
ck±
 = 
tf
.
Œaš
.
	$g‘_checkpošt_¡©e
(
CHECKPOINT_DIR
)

48 
ck±
 
ªd
 ck±.
mod–_checkpošt_·th
:

49 #Re¡Üe 
äom
 
checkpošt


50 
§v”
.
	$»¡Üe
(
£ss
, 
ck±
.
mod–_checkpošt_·th
)

51 #Assumšg 
mod–_checkpošt_·th
 
looks
 
som‘hšg
 
like
:

52 #/
my
-
çvÜ™e
-
·th
/
ciçr10_Œaš
/
mod–
.
ck±
-0,

53 #exŒaù 
glob®_¡•
 
äom
 
™
.

54 
glob®_¡•
 = 
ck±
.
mod–_checkpošt_·th
.
	`¥l™
('/')[-1].split('-')[

56 
	`´št
("\nglob® s‹p:", 
glob®_¡•
)

58 
	`´št
('No checkpoint file found')

61 #S¹ 
the
 
queue
 
ruÂ”s
.

62 
coÜd
 = 
tf
.
Œaš
.
	$CoÜdš©Ü
()

63 
Œy
:

64 
th»ads
 = []

65 
qr
 
š
 
tf
.
	$g‘_cŞËùiÚ
(
tf
.
G¿phKeys
.
QUEUE_RUNNERS
):

66 
th»ads
.
	`ex‹nd
(
qr
.
	$ü—‹_th»ads
(
£ss
,

67 
coÜd
=coord,

68 
d«mÚ
=
True
,

69 
¡¬t
=
True
))

71 
num_™”
 = (
m©h
.
	`û
(
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 /

72 
FLAGS
.
b©ch_size
))

73 
Œue_couÁ
 = 0 #CouÁ 
the
 
numb”
 
of
 
cÜ»ù
 
´ediùiÚs
.

74 
tÙ®_§m¶e_couÁ
 = 
num_™”
 * 
FLAGS
.
b©ch_size


75 
¡•
 = 0

76 
¡•
 < 
num_™”
 
ªd
 
nÙ
 
coÜd
.
	$should_¡İ
():

77 
´ediùiÚs
 = 
£ss
.
	$run
([
tİ_k_İ
])

78 
Œue_couÁ
 +ğ
Å
.
	$sum
(
´ediùiÚs
)

79 
¡•
 += 1

81 #Compu‹ 
´ecisiÚ
 @ 1.

82 
´ecisiÚ
 = 
Œue_couÁ
 / 
tÙ®_§m¶e_couÁ


83 
	`´št
('%s:…»cisiÚ @ 1 = %.3f' % (
d©‘ime
.
	`now
(), 
´ecisiÚ
))

85 
summ¬y
 = 
tf
.
	$Summ¬y
()

86 
summ¬y
.
	`P¬£FromSŒšg
(
£ss
.
	$run
(
summ¬y_İ
))

87 
summ¬y
.
v®ue
.
	`add
(
g
='P»cisiÚ @ 1', 
sim¶e_v®ue
=
´ecisiÚ
)

88 
summ¬y_wr™”
.
	$add_summ¬y
(
summ¬y
, 
glob®_¡•
)

89 
	`´št
("writeƒval summary")

90 
exû±
 
Exû±iÚ
 
as
 
e
: #pylšt: 
di§bË
=
brßd
-except

91 
coÜd
.
	$»que¡_¡İ
(
e
)

93 
coÜd
.
	$»que¡_¡İ
()

94 
coÜd
.
	$još
(
th»ads
, 
¡İ_g¿û_³riod_£cs
=10)

97 
def
 
	$ev®u©e
():

99 
w™h
 
tf
.
	`G¿ph
().
	$as_deçuÉ
(è
as
 
g
, 
tf
.
	`deviû
("/cpu:0"):

100 #G‘ 
£qu’ûs
 
ªd
 
Ïb–s


101 
£qu’ûs
, 
Ïb–s
 = 
mod–
.
	$šputs_ev®
()

103 #Bud 
a
 
G¿ph
 
th©
 
compu‹s
 
the
 
log™s
 
´ediùiÚs
 
äom
he

104 #šã»nû 
mod–
.

105 
log™s
 = 
mod–
.
	$šã»nû
(
£qu’ûs
)

107 #C®cuÏ‹ 
´ediùiÚs
.

108 
tİ_k_İ
 = 
tf
.
Â
.
	$š_tİ_k
(
log™s
, 
Ïb–s
, 1)

110 ## 
Re¡Üe
 
the
 
movšg
 
av”age
 
v”siÚ
 
of
h
Ë¬Ãd
 
v¬ŸbËs
 
ev®
.

111 #v¬ŸbË_av”age ğ
tf
.
Œaš
.
	`ExpÚ’tŸlMovšgAv”age
(

112 #mod–.
MOVING_AVERAGE_DECAY
)

113 #v¬ŸbËs_to_»¡Üğ
v¬ŸbË_av”ages
.
	`v¬ŸbËs_to_»¡Üe
()

114 #§v” = 
tf
.
Œaš
.
	`Sav”
(
v¬ŸbËs_to_»¡Üe
)

115 
§v”
 = 
tf
.
Œaš
.
	`Sav”
Ñf.
	$®l_v¬ŸbËs
())

117 #Bud 
the
 
summ¬y
 
İ”©iÚ
 
ba£d
 
Ú
h
TF
 
cŞËùiÚ
 
of
 
Summ¬›s
.

118 
summ¬y_İ
 = 
tf
.
	$m”ge_®l_summ¬›s
()

120 
summ¬y_wr™”
 = 
tf
.
Œaš
.
	$Summ¬yWr™”
(
EVAL_DIR
, 
g
)

122 
True
:

123 
	$ev®_Úû
(
§v”
, 
summ¬y_wr™”
, 
tİ_k_İ
, 
summ¬y_İ
)

124 
FLAGS
.
run_Úû
:

125 
	`´št
("eval only once, stopeƒval")

127 
	`´št
("¦“°fÜ {} secÚds".
	$fÜm©
(
FLAGS
.
ev®_š‹rv®_£cs
))

128 
time
.
	$¦“p
(
FLAGS
.
ev®_š‹rv®_£cs
)

131 
def
 
	$maš
(
¬gv
=
NÚe
): #pylšt: 
di§bË
=
unu£d
-
¬gum’t


133 
	`´št
("\nParameters:")

134 
©Œ
, 
v®ue
 
š
 
	`sÜ‹d
(
FLAGS
.
__æags
.
	$™ems
()):

135 
	`´št
("{}={}".
	`fÜm©
(
©Œ
.
	`uµ”
(), 
v®ue
))

136 
	`´št
("end")

138 
	$´št
(
CHECKPOINT_DIR
)

139 
tf
.
gfe
.
	$Exi¡s
(
CHECKPOINT_DIR
):

140 
d©a£t
 = 
os
.
·th
.
	`ba£Çme
(
FLAGS
.
Œaš_dœ
).
	`¥l™
('.')[0]

141 
d©a£t
='rotten'

145 #ià
nÙ
 
mod–
.
	`š™Ÿl_d©a£t_šfo
(
d©a£t
):

148 
d©a£t
 == "rotten":

149 
mod–
.
NUM_CLASSES
 = 2

150 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 8530

151 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 2132

152 
–if
 
d©a£t
 == "ag":

153 
mod–
.
NUM_CLASSES
 = 4

154 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 0

155 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 0

156 
–if
 
d©a£t
 == "newsgroups":

157 
mod–
.
NUM_CLASSES
 = 4

158 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 0

159 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 0

160 
–if
 
d©a£t
 == "imdb":

161 
mod–
.
NUM_CLASSES
 = 2

162 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 0

163 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 0

165 
	`´št
("wrong dataset")

167 
	$´št
(
mod–
.
NUM_CLASSES
)

168 
tf
.
gfe
.
	$Exi¡s
(
EVAL_DIR
):

169 
tf
.
gfe
.
	$D–‘eRecursiv–y
(
EVAL_DIR
)

170 
tf
.
gfe
.
	$MakeDœs
(
EVAL_DIR
)

171 
	$ev®u©e
()

173 
	`´št
("error: cannot find checkpoints directory!")

176 
__Çme__
 == '__main__':

177 
tf
.
­p
.
	`run
()

	@cnn_character/model.py

2 
äom
 
__futu»__
 
impÜt
 
absŞu‹_impÜt


3 
äom
 
__futu»__
 
impÜt
 
divisiÚ


4 
äom
 
__futu»__
 
impÜt
 
´št_funùiÚ


6 
impÜt
 
»


8 
impÜt
 
‹nsÜæow
 
as
 
tf


10 
impÜt
 
šputs


12 
	gFLAGS
 = 
tf
.
­p
.
æags
.
FLAGS


14 #Basiø
mod–
 
·¿m‘”s
.

15 
tf
.
­p
.
æags
.
DEFINE_š‹g”
("num_epochs", 100,

17 
	gtf
.
	g­p
.
	gæags
.
DEFINE_š‹g”
("minibatch_size", 128,

20 #glob® 
cÚ¡ªts


22 #thi 
th»e
 
d©a£t
 
»Ï‹d
 
v¬ŸbË
 
¬e
 
š™Ÿlized
 
š
 
Œaš
.
maš


26 #ouuˆ
num
 
cÚv
 
Ïy”


27 
	gFEATURE_NUM
 = 256

29 #CÚ¡ªt 
desüibšg
 
the
 
Œaššg
 
´oûss
.

30 
MOVING_AVERAGE_DECAY
 = 0.9999 #Th
deÿy
 
to
 
u£
 
the
 
movšg
 
av”age
.

31 
NUM_EPOCHS_PER_DECAY
 = 350.0 #Epoch 
aá”
 
which
 
Ë¬nšg
 
¿‹
 
deÿys
.

32 
LEARNING_RATE_DECAY_FACTOR
 = 0.1 #L—ºšg 
¿‹
 
deÿy
 
çùÜ
.

33 
INITIAL_LEARNING_RATE
 = 0.1 #In™ŸÈ
Ë¬nšg
 
¿‹
.

35 #Ià
a
 
mod–
 
is
 
Œašed
 
w™h
 
muÉË
 
GPUs
, 
´efix
 
®l
 
Op
 
Çmes
 w™h 
tow”_Çme


36 #tØ
difã»ÁŸ‹
 
the
 
İ”©iÚs
. 
NÙe
 
th©
 
this
 
´efix
 
is
 
»moved
 
äom
he

37 #Çme 
of
 
the
 
summ¬›s
 
wh’
 
visu®izšg
 
a
 
mod–
.

38 
	gTOWER_NAME
 = 'tower'

40 
def
 
	$š™Ÿl_d©a£t_šfo
(
d©a£t
):

41 
d©a£t
 == "rotten":

42 
NUM_CLASSES
 = 2

43 
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 8530

44 
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 2132

45 
–if
 
d©a£t
 == "ag":

46 
NUM_CLASSES
 = 4

47 
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 0

48 
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 0

49 
–if
 
d©a£t
 == "newsgroups":

50 
NUM_CLASSES
 = 4

51 
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 0

52 
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 0

53 
–if
 
d©a£t
 == "imdb":

54 
NUM_CLASSES
 = 2

55 
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 0

56 
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 0

58 
	`´št
("wrong dataset")

59  
F®£


60  
True


61 
def
 
	$_aùiv©iÚ_summ¬y
(
x
):

63 
C»©es
 
a
 
summ¬y
 
th©
 
´ovides
‡ 
hi¡og¿m
 
of
 
aùiv©iÚs
.

64 
C»©es
 
a
 
summ¬y
 
th©
 
m—su»
 
the
 
¥¬s™y
 
of
 
aùiv©iÚs
.

65 
Args
:

66 
x
: 
T’sÜ


67 
R‘uºs
:

68 
nÙhšg


70 #Remov'tow”_[0-9]/' 
äom
 
the
 
Çme
 
š
 
this
 
is
 
a
 
muÉi
-
GPU
 
Œaššg


71 #£ssiÚ. 
This
 
h–ps
 
the
 
ş¬™y
 
of
 
´e£Á©iÚ
 
Ú
 
‹nsÜbßrd
.

72 
‹nsÜ_Çme
 = 
»
.
	`sub
('%s_[0-9]*/' % 
TOWER_NAME
, '', 
x
.
İ
.
Çme
)

73 
tf
.
	`hi¡og¿m_summ¬y
(
‹nsÜ_Çme
 + '/aùiv©iÚs', 
x
)

74 
tf
.
	`sÿÏr_summ¬y
(
‹nsÜ_Çme
 + '/¥¬s™y',f.
Â
.
	$z”o_äaùiÚ
(
x
))

77 
def
 
	$_v¬ŸbË_Ú_ıu
(
Çme
, 
sh­e
, 
š™Ÿliz”
):

79 
Args
:

80 
Çme
:‚am
of
 
the
 
v¬ŸbË


81 
sh­e
: 
li¡
 
of
 
šts


82 
š™Ÿliz”
: in™Ÿliz” 
V¬ŸbË


83 
R‘uºs
:

84 
V¬ŸbË
 
T’sÜ


86 
w™h
 
tf
.
	`deviû
('/cpu:0'):

87 
v¬
 = 
tf
.
	$g‘_v¬ŸbË
(
Çme
, 
sh­e
, 
š™Ÿliz”
=initializer)

88  
v¬


91 
def
 
	$_v¬ŸbË_w™h_weight_deÿy
(
Çme
, 
sh­e
, 
¡ddev
, 
wd
):

93 
NÙe
 
th©
 
the
 
V¬ŸbË
 
is
 
š™Ÿlized
 
w™h
 
a
 
Œunÿ‹d
 
nÜm®
 
di¡ributiÚ
.

94 
A
 
weight
 
deÿy
 
is
 
added
 
Úly
 
Úe
 i 
¥ecif›d
.

95 
Args
:

96 
Çme
:‚am
of
 
the
 
v¬ŸbË


97 
sh­e
: 
li¡
 
of
 
šts


98 
¡ddev
: 
¡ªd¬d
 
devŸtiÚ
 
of
 
a
 
Œunÿ‹d
 
GaussŸn


99 
wd
: 
add
 
L2Loss
 
weight
 
deÿy
 
muÉl›d
 
by
 
this
 . 
If
 
NÚe
, weight

100 
deÿy
 
is
 
nÙ
 
added
 
this
 
V¬ŸbË
.

101 
R‘uºs
:

102 
V¬ŸbË
 
T’sÜ


104 
v¬
 = 
	`_v¬ŸbË_Ú_ıu
(
Çme
,

105 
sh­e
,

106 
tf
.
	$Œunÿ‹d_nÜm®_š™Ÿliz”
(
¡ddev
=stddev))

107 
wd
 
is
 
nÙ
 
NÚe
:

108 
weight_deÿy
 = 
tf
.
	`mul
Ñf.
Â
.
	`l2_loss
(
v¬
), 
wd
, 
Çme
='weight_loss')

109 
tf
.
	`add_to_cŞËùiÚ
('los£s', 
weight_deÿy
)

110  
v¬


113 
def
 
	$šputs_Œaš
():

115 
R‘uºs
:

116 
£qu’ûs
: 4D 
‹nsÜ
 
of
 [
b©ch_size
, 1, 
šput_Ëngth
, 
®phab‘_Ëngth
] 
size
.

117 
Ïb–s
: 
Lab–s
. 1D 
‹nsÜ
 
of
 [
b©ch_size
] 
size
.

119  
šputs
.
	`šputs_ch¬aù”
("train",

120 
FLAGS
.
mšib©ch_size
,

121 
FLAGS
.
num_•ochs
,

122 
mš_shufæe
=1000)

125 
def
 
	$šputs_ev®
():

127 
sim¬
 
to
 
šputs_Œaš


130  
šputs
.
	`šputs_ch¬aù”
("test",

131 
FLAGS
.
mšib©ch_size
,

132 
NÚe
,

133 
mš_shufæe
=1)

136 
def
 
	$šã»nû
(
£qu’ûs
):

138 
Args
:

139 
£qu’ûs
: 
Sequ’ûs
 
»tuºed
 
äom
 
	$šputs_Œaš
(è
Ü
 
šputs_ev®
.

140 
R‘uºs
:

141 
Log™s
.

143 #W
š¡ªtŸ‹
 
®l
 
v¬ŸbËs
 
usšg
 
tf
.
	`g‘_v¬ŸbË
(è
š¡—d
 
of


144 #tf.
	`V¬ŸbË
(è
š
 
Üd”
 
to
 
sh¬e
 
v¬ŸbËs
 
bÙh
 
Œaššg
 
ªd


148 
w™h
 
tf
.
	`v¬ŸbË_scİe
('cÚv1'è
as
 
scİe
:

149 
k”Ãl
 = 
	`_v¬ŸbË_w™h_weight_deÿy
(

151 
sh­e
=[1, 7, 
FLAGS
.
®phab‘_Ëngth
 + 1, 
FEATURE_NUM
],

152 
¡ddev
=0.02,

153 
wd
=
NÚe
)

154 
cÚv
 = 
tf
.
Â
.
	`cÚv2d
(
£qu’ûs
, 
k”Ãl
, [1, 1, 1, 1], 
·ddšg
='SAME')

155 
bŸ£s
 = 
	`_v¬ŸbË_Ú_ıu
('bŸ£s', [
FEATURE_NUM
],

156 
tf
.
	$cÚ¡ªt_š™Ÿliz”
(0.02))

157 
bŸs
 = 
tf
.
Â
.
	$bŸs_add
(
cÚv
, 
bŸ£s
)

158 
cÚv1
 = 
tf
.
Â
.
	$»lu
(
bŸs
, 
Çme
=
scİe
.name)

159 
	$_aùiv©iÚ_summ¬y
(
cÚv1
)

162 
poŞ1
 = 
tf
.
Â
.
	`max_poŞ
(
cÚv1
,

163 
ksize
=[1, 1, 3, 1],

164 
¡rides
=[1, 1, 3, 1],

165 
·ddšg
='SAME',

166 
Çme
='pool1')

169 
w™h
 
tf
.
	`v¬ŸbË_scİe
('cÚv2'è
as
 
scİe
:

170 
k”Ãl
 = 
	`_v¬ŸbË_w™h_weight_deÿy
(

172 
sh­e
=[1, 7, 
FEATURE_NUM
, FEATURE_NUM],

173 
¡ddev
=0.02,

174 
wd
=
NÚe
)

175 
cÚv
 = 
tf
.
Â
.
	`cÚv2d
(
poŞ1
, 
k”Ãl
, [1, 1, 1, 1], 
·ddšg
='SAME')

176 
bŸ£s
 = 
	`_v¬ŸbË_Ú_ıu
('bŸ£s', [
FEATURE_NUM
],

177 
tf
.
	$cÚ¡ªt_š™Ÿliz”
(0.02))

178 
bŸs
 = 
tf
.
Â
.
	$bŸs_add
(
cÚv
, 
bŸ£s
)

179 
cÚv2
 = 
tf
.
Â
.
	$»lu
(
bŸs
, 
Çme
=
scİe
.name)

180 
	$_aùiv©iÚ_summ¬y
(
cÚv2
)

183 
poŞ2
 = 
tf
.
Â
.
	`max_poŞ
(
cÚv2
,

184 
ksize
=[1, 1, 3, 1],

185 
¡rides
=[1, 1, 3, 1],

186 
·ddšg
='SAME',

187 
Çme
='pool2')

190 
w™h
 
tf
.
	`v¬ŸbË_scİe
('cÚv3'è
as
 
scİe
:

191 
k”Ãl
 = 
	`_v¬ŸbË_w™h_weight_deÿy
(

193 
sh­e
=[1, 3, 
FEATURE_NUM
, FEATURE_NUM],

194 
¡ddev
=0.02,

195 
wd
=
NÚe
)

196 
cÚv
 = 
tf
.
Â
.
	`cÚv2d
(
poŞ2
, 
k”Ãl
, [1, 1, 1, 1], 
·ddšg
='SAME')

197 
bŸ£s
 = 
	`_v¬ŸbË_Ú_ıu
('bŸ£s', [
FEATURE_NUM
],

198 
tf
.
	$cÚ¡ªt_š™Ÿliz”
(0.02))

199 
bŸs
 = 
tf
.
Â
.
	$bŸs_add
(
cÚv
, 
bŸ£s
)

200 
cÚv3
 = 
tf
.
Â
.
	$»lu
(
bŸs
, 
Çme
=
scİe
.name)

201 
	$_aùiv©iÚ_summ¬y
(
cÚv3
)

204 
w™h
 
tf
.
	`v¬ŸbË_scİe
('cÚv4'è
as
 
scİe
:

205 
k”Ãl
 = 
	`_v¬ŸbË_w™h_weight_deÿy
(

207 
sh­e
=[1, 3, 
FEATURE_NUM
, FEATURE_NUM],

208 
¡ddev
=0.02,

209 
wd
=
NÚe
)

210 
cÚv
 = 
tf
.
Â
.
	`cÚv2d
(
cÚv3
, 
k”Ãl
, [1, 1, 1, 1], 
·ddšg
='SAME')

211 
bŸ£s
 = 
	`_v¬ŸbË_Ú_ıu
('bŸ£s', [
FEATURE_NUM
],

212 
tf
.
	$cÚ¡ªt_š™Ÿliz”
(0.02))

213 
bŸs
 = 
tf
.
Â
.
	$bŸs_add
(
cÚv
, 
bŸ£s
)

214 
cÚv4
 = 
tf
.
Â
.
	$»lu
(
bŸs
, 
Çme
=
scİe
.name)

215 
	$_aùiv©iÚ_summ¬y
(
cÚv4
)

218 
w™h
 
tf
.
	`v¬ŸbË_scİe
('cÚv5'è
as
 
scİe
:

219 
k”Ãl
 = 
	`_v¬ŸbË_w™h_weight_deÿy
(

221 
sh­e
=[1, 3, 
FEATURE_NUM
, FEATURE_NUM],

222 
¡ddev
=0.02,

223 
wd
=
NÚe
)

224 
cÚv
 = 
tf
.
Â
.
	`cÚv2d
(
cÚv4
, 
k”Ãl
, [1, 1, 1, 1], 
·ddšg
='SAME')

225 
bŸ£s
 = 
	`_v¬ŸbË_Ú_ıu
('bŸ£s', [
FEATURE_NUM
],

226 
tf
.
	$cÚ¡ªt_š™Ÿliz”
(0.02))

227 
bŸs
 = 
tf
.
Â
.
	$bŸs_add
(
cÚv
, 
bŸ£s
)

228 
cÚv5
 = 
tf
.
Â
.
	$»lu
(
bŸs
, 
Çme
=
scİe
.name)

229 
	$_aùiv©iÚ_summ¬y
(
cÚv5
)

232 
w™h
 
tf
.
	`v¬ŸbË_scİe
('cÚv6'è
as
 
scİe
:

233 
k”Ãl
 = 
	`_v¬ŸbË_w™h_weight_deÿy
(

235 
sh­e
=[1, 3, 
FEATURE_NUM
, FEATURE_NUM],

236 
¡ddev
=0.02,

237 
wd
=
NÚe
)

238 
cÚv
 = 
tf
.
Â
.
	`cÚv2d
(
cÚv5
, 
k”Ãl
, [1, 1, 1, 1], 
·ddšg
='SAME')

239 
bŸ£s
 = 
	`_v¬ŸbË_Ú_ıu
('bŸ£s', [
FEATURE_NUM
],

240 
tf
.
	$cÚ¡ªt_š™Ÿliz”
(0.02))

241 
bŸs
 = 
tf
.
Â
.
	$bŸs_add
(
cÚv
, 
bŸ£s
)

242 
cÚv6
 = 
tf
.
Â
.
	$»lu
(
bŸs
, 
Çme
=
scİe
.name)

243 
	$_aùiv©iÚ_summ¬y
(
cÚv6
)

246 
poŞ6
 = 
tf
.
Â
.
	`max_poŞ
(
cÚv6
,

247 
ksize
=[1, 1, 3, 1],

248 
¡rides
=[1, 1, 3, 1],

249 
·ddšg
='SAME',

250 
Çme
='pool6')

253 
w™h
 
tf
.
	`v¬ŸbË_scİe
('loÿl7'è
as
 
scİe
:

254 #Mov
ev”ythšg
 
što
 
d•th
 
so
 
we
 
ÿn
 
³rfÜm
 
a
 
sšgË
 
m©rix
 
muÉly
.

255 
»sh­e
 = 
tf
.
	`»sh­e
(
poŞ6
, [
FLAGS
.
mšib©ch_size
, -1])

256 
dim
 = 
»sh­e
.
	`g‘_sh­e
()[1].
v®ue


258 
weights
 = 
	`_v¬ŸbË_w™h_weight_deÿy
('weights',

259 
sh­e
=[
dim
, 1024],

260 
¡ddev
=0.02,

261 
wd
=
NÚe
)

262 
bŸ£s
 = 
	`_v¬ŸbË_Ú_ıu
('biases', [1024],

263 
tf
.
	$cÚ¡ªt_š™Ÿliz”
(0.02))

264 
loÿl7
 = 
tf
.
Â
.
	`»lu
(

265 
tf
.
	`m©mul
(
»sh­e
, 
weights
è+ 
bŸ£s
,

266 
Çme
=
scİe
.name)

267 
	$_aùiv©iÚ_summ¬y
(
loÿl7
)

270 
drİout7
 = 
tf
.
Â
.
	`drİout
(
loÿl7
, 
FLAGS
.
drİout_k“p_´ob
, 
Çme
="dropout7")

273 
w™h
 
tf
.
	`v¬ŸbË_scİe
('loÿl8'è
as
 
scİe
:

274 
weights
 = 
	`_v¬ŸbË_w™h_weight_deÿy
('weights',

275 
sh­e
=[1024, 1024],

276 
¡ddev
=0.02,

277 
wd
=
NÚe
)

278 
bŸ£s
 = 
	`_v¬ŸbË_Ú_ıu
('biases', [1024],

279 
tf
.
	$cÚ¡ªt_š™Ÿliz”
(0.02))

280 
loÿl8
 = 
tf
.
Â
.
	`»lu
(

281 
tf
.
	`m©mul
(
drİout7
, 
weights
è+ 
bŸ£s
,

282 
Çme
=
scİe
.name)

283 
	$_aùiv©iÚ_summ¬y
(
loÿl8
)

286 
drİout8
 = 
tf
.
Â
.
	`drİout
(
loÿl8
, 
FLAGS
.
drİout_k“p_´ob
, 
Çme
="dropout8")

288 #soámax, 
i
.
e
. 
	`soámax
(
WX
 + 
b
)

289 
w™h
 
tf
.
	`v¬ŸbË_scİe
('soámax_lš—r'è
as
 
scİe
:

290 
	`´št
 ("NUM_CLASSES:", 
NUM_CLASSES
)

291 
weights
 = 
	`_v¬ŸbË_w™h_weight_deÿy
('weights',

292 [1024, 
NUM_CLASSES
],

293 
¡ddev
=0.02,

294 
wd
=
NÚe
)

295 
bŸ£s
 = 
	`_v¬ŸbË_Ú_ıu
('bŸ£s', [
NUM_CLASSES
],

296 
tf
.
	$cÚ¡ªt_š™Ÿliz”
(0.02))

297 
soámax_lš—r
 = 
tf
.
	`add
(

298 
tf
.
	`m©mul
(
drİout8
, 
weights
),

299 
bŸ£s
,

300 
Çme
=
scİe
.name)

301 
	$_aùiv©iÚ_summ¬y
(
soámax_lš—r
)

303  
soámax_lš—r


306 
def
 
	$loss
(
log™s
, 
Ïb–s
):

308 
Add
 
summ¬y
 "Loss" 
ªd
 "Loss/avg".

309 
Args
:

310 
log™s
: 
Log™s
 
äom
 
	`šã»nû
().

311 
Ïb–s
: 
Lab–s
 
äom
 
di¡Ü‹d_šputs
 
Ü
 
	`šputs
(). 1-
D
 
‹nsÜ


312 
of
 
sh­e
 [
b©ch_size
]

313 
R‘uºs
:

314 
Loss
 
‹nsÜ
 
of
 
ty³
 .

316 #C®cuÏ‹ 
the
 
av”age
 
üoss
 
’Œİy
 
loss
 
aüoss
h
b©ch
.

317 
Ïb–s
 = 
tf
.
	$ÿ¡
(
Ïb–s
, 
tf
.
št64
)

318 
üoss_’Œİy
 = 
tf
.
Â
.
	`¥¬£_soámax_üoss_’Œİy_w™h_log™s
(

319 
log™s
,

320 
Ïb–s
,

321 
Çme
='cross_entropy_per_example')

322 
üoss_’Œİy_m—n
 = 
tf
.
	`»duû_m—n
(
üoss_’Œİy
, 
Çme
='cross_entropy')

323 
tf
.
	`add_to_cŞËùiÚ
('los£s', 
üoss_’Œİy_m—n
)

325 #Th
tÙ®
 
loss
 
is
 
defšed
 
as
 
the
 
üoss
 
’Œİy
†os 
¶us
 
®l
 
of
h
weight


326 #deÿy 
	`‹rms
 (
L2
 
loss
).

327  
tf
.
	`add_n
Ñf.
	`g‘_cŞËùiÚ
('los£s'), 
Çme
='total_loss')

330 
def
 
	$_add_loss_summ¬›s
(
tÙ®_loss
):

332 
G’”©es
 
movšg
 
av”age
 
®l
 
los£s
 
ªd
 
assocŸ‹d
 
summ¬›s
 

333 
visu®izšg
 
the
 
³rfÜmªû
 
of
h
ÃtwÜk
.

334 
Args
:

335 
tÙ®_loss
: 
TÙ®
 
loss
 
äom
 
	`loss
().

336 
R‘uºs
:

337 
loss_av”ages_İ
: 
İ
 
g’”©šg
 
movšg
 
av”ages
 
of
 
los£s
.

339 #Compu‹ 
the
 
movšg
 
av”age
 
of
 
®l
 
šdividu®
 
los£s
 
ªd
h
tÙ®
 
loss
.

340 
loss_av”ages
 = 
tf
.
Œaš
.
	`ExpÚ’tŸlMovšgAv”age
(0.9, 
Çme
='avg')

341 
los£s
 = 
tf
.
	`g‘_cŞËùiÚ
('losses')

342 
loss_av”ages_İ
 = 
loss_av”ages
.
	`­¶y
(
los£s
 + [
tÙ®_loss
])

344 #A‰ach 
a
 
sÿÏr
 
summ¬y
 
to
 
®l
 
šdividu®
 
los£s
 
ªd
 
the
 
tÙ®
 
loss
; dohe

345 #§m
the
 
av”aged
 
v”siÚ
 
of
h
los£s
.

346 
l
 
š
 
los£s
 + [
tÙ®_loss
]:

347 #Nam
—ch
 
loss
 
as
 'Ôaw)' 
ªd
 
Çme
 
the
 
movšg
 
av”age
 
v”siÚ
 
of
he†oss

348 #a 
the
 
Üigš®
 
loss
 
Çme
.

349 
tf
.
	`sÿÏr_summ¬y
(
l
.
İ
.
Çme
 + ' (raw)',†)

350 
tf
.
	`sÿÏr_summ¬y
(
l
.
İ
.
Çme
, 
loss_av”ages
.
	$av”age
(
l
))

352  
loss_av”ages_İ


355 
def
 
	$Œaššg
(
tÙ®_loss
, 
glob®_¡•
):

357 
C»©e
 
ª
 
İtimiz”
 
ªd
 
­¶y
 
to
 
®l
 
ŒašabË
 
v¬ŸbËs
. 
Add
 
movšg


358 
av”age
 
®l
 
ŒašabË
 
v¬ŸbËs
.

359 
Args
:

360 
tÙ®_loss
: 
TÙ®
 
loss
 
äom
 
	`loss
().

361 
glob®_¡•
: 
IÁeg”
 
V¬ŸbË
 
couÁšg
 
the
 
numb”
 
of
 
Œaššg
 
¡•s


362 
´oûs£d
.

363 
R‘uºs
:

364 
Œaš_İ
: 
İ
 
Œaššg
.

366 #V¬ŸbË 
th©
 
afãù
 
Ë¬nšg
 
¿‹
.

367 
num_b©ches_³r_•och
 = 
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 / 
FLAGS
.
mšib©ch_size


368 
deÿy_¡•s
 = (
num_b©ches_³r_•och
 * 
NUM_EPOCHS_PER_DECAY
)

370 #Deÿy 
the
 
Ë¬nšg
 
¿‹
 
expÚ’tŸÎy
 
ba£d
 
Ú
h
numb”
 
of
 
¡•s
.

371 
Ì_deÿy
 = 
tf
.
Œaš
.
	$expÚ’tŸl_deÿy
(
INITIAL_LEARNING_RATE
,

372 
glob®_¡•
,

373 
deÿy_¡•s
,

374 
LEARNING_RATE_DECAY_FACTOR
,

375 
¡aœÿ£
=
True
)

376 #com·» 
w™h
 0.01 * 0.5^10

377 
Ì
 = 
tf
.
	$maximum
(
Ì_deÿy
, 0.000009765625)

378 
tf
.
	`sÿÏr_summ¬y
('Ë¬nšg_¿‹', 
Ì
)

380 #G’”©
movšg
 
av”ages
 
of
 
®l
 
los£s
 
ªd
 
assocŸ‹d
 
summ¬›s
.

381 
loss_av”ages_İ
 = 
	$_add_loss_summ¬›s
(
tÙ®_loss
)

383 #Compu‹ 
g¿d›Ás
.

384 
w™h
 
tf
.
	$cÚŒŞ_d•’d’c›s
([
loss_av”ages_İ
]):

385 #İˆğ
tf
.
Œaš
.
	`G¿d›ÁDesûÁO±imiz”
(
Ì
)

386 
İt
 = 
tf
.
Œaš
.
	$Mom’tumO±imiz”
(
Ì
, 0.9)

387 
g¿ds
 = 
İt
.
	$compu‹_g¿d›Ás
(
tÙ®_loss
)

389 #Aµly 
g¿d›Ás
.

390 
­¶y_g¿d›Á_İ
 = 
İt
.
	$­¶y_g¿d›Ás
(
g¿ds
, 
glob®_¡•
=global_step)

392 #Add 
hi¡og¿ms
 
ŒašabË
 
v¬ŸbËs
.

393 
v¬
 
š
 
tf
.
	$ŒašabË_v¬ŸbËs
():

394 
tf
.
	$hi¡og¿m_summ¬y
(
v¬
.
İ
.
Çme
, var)

396 #Add 
hi¡og¿ms
 
g¿d›Ás
.

397 
g¿d
, 
v¬
 
š
 
g¿ds
:

398 
g¿d
 
is
 
nÙ
 
NÚe
:

399 
tf
.
	`hi¡og¿m_summ¬y
(
v¬
.
İ
.
Çme
 + '/g¿d›Ás', 
g¿d
)

401 ## 
T¿ck
 
the
 
movšg
 
av”ages
 
of
 
®l
 
ŒašabË
 
v¬ŸbËs
.

402 #v¬ŸbË_av”age ğ
tf
.
Œaš
.
	`ExpÚ’tŸlMovšgAv”age
(
MOVING_AVERAGE_DECAY
,

404 #v¬ŸbËs_av”ages_İ = 
v¬ŸbË_av”ages
.
	`­¶y
(
tf
.
	`ŒašabË_v¬ŸbËs
())

406 
w™h
 
tf
.
	$cÚŒŞ_d•’d’c›s
([
­¶y_g¿d›Á_İ
]):

407 
Œaš_İ
 = 
tf
.
	`no_İ
(
Çme
='train')

409  
Œaš_İ


	@cnn_character/train.py

1 
äom
 
__futu»__
 
impÜt
 
absŞu‹_impÜt


2 
äom
 
__futu»__
 
impÜt
 
divisiÚ


3 
äom
 
__futu»__
 
impÜt
 
´št_funùiÚ


5 
äom
 
d©‘ime
 
impÜt
 datetime

6 
impÜt
 
	gos
.
·th


7 
impÜt
 
time


9 
impÜt
 
numpy
 
as
 
Å


10 
impÜt
 
‹nsÜæow
 
as
 
	gtf


12 #äom 
ún_ch¬aù”
.
mod–
 
impÜt
 model

13 
äom
 
ún_ch¬aù”
 
impÜt
 
	gmod–


17 
	gFLAGS
 = 
tf
.
­p
.
æags
.
FLAGS


19 #Mod– 
Hy³½¬am‘”s


20 #tf.
­p
.
æags
.
DEFINE_š‹g”
(

21 #"
šput_Ëngth
", 1014,

22 #"
numb”
 
of
 
ch¬aù”s
 
š
 
—ch
 
šput
 
£qu’ûs
 (: 1014)")

23 
tf
.
­p
.
æags
.
DEFINE_æßt
("dropout_keep_prob", 0.5,

26 #T¿ššg 
·¿m‘”s


27 
tf
.
­p
.
æags
.
DEFINE_š‹g”
(

30 
tf
.
­p
.
æags
.
DEFINE_š‹g”
("checkpoint_every", 100,

32 #Misø
P¬am‘”s


33 
tf
.
­p
.
æags
.
DEFINE_boŞ—n
("®low_soá_¶aûm’t", 
True
,

35 #tf.
­p
.
æags
.
DEFINE_boŞ—n
("log_deviû_¶aûm’t", 
F®£
,

36 #"
Log
 
¶aûm’t
 
of
 
İs
 
Ú
 
deviûs
")

38 
tf
.
­p
.
æags
.
DEFINE_¡ršg
('outputs_dir', 'cnn_character/outputs',

41 
tf
.
­p
.
æags
.
DEFINE_š‹g”
('max_steps', 1000000,

43 
tf
.
­p
.
æags
.
DEFINE_boŞ—n
('log_deviû_¶aûm’t', 
F®£
,

45 
tf
.
­p
.
æags
.
DEFINE_š‹g”
('print_step', 1,

47 
tf
.
­p
.
æags
.
DEFINE_š‹g”
('summary_step', 3,

49 
tf
.
­p
.
æags
.
DEFINE_š‹g”
('checkpoint_step', 50,

51 
tf
.
­p
.
æags
.
DEFINE_š‹g”
('num_checkpoints', 10,

55 #Ouuˆ
dœeùÜy
 
checkpošts
 
ªd
 
summ¬›s


56 
time¡amp
 = 
FLAGS
.
d©a£t
 + '.' + 
¡r
(
d©‘ime
.
now
().
¡ráime
("%Y-%m-%d.%H-%M-%S"))

57 
TRAIN_DIR
 = 
os
.
·th
.
ab¥©h
(os.·th.
	$još
(
FLAGS
.
ouuts_dœ
, 
time¡amp
))

58 
SUMMARY_DIR
 = 
os
.
·th
.
	`još
(
TRAIN_DIR
, "summaries")

59 
CHECKPOINT_DIR
 = 
os
.
·th
.
	`još
(
TRAIN_DIR
, "checkpoints")

60 
CHECKPOINT_PATH
 = 
os
.
·th
.
	`još
(
CHECKPOINT_DIR
, 'model.ckpt')

66 
def
 
	$Œaš
():

68 
	`´št
("startraining...")

69 
w™h
 
tf
.
	`G¿ph
().
	$as_deçuÉ
():

70 
glob®_¡•
 = 
tf
.
	$V¬ŸbË
(0, 
ŒašabË
=
F®£
)

72 #g‘ 
šput
 
d©a


73 
£qu’ûs
, 
Ïb–s
 = 
mod–
.
	$šputs_Œaš
()

75 #Bud 
a
 
G¿ph
 
th©
 
compu‹s
 
the
 
log™s
 
´ediùiÚs
 
äom
he

76 #šã»nû 
mod–
.

77 
log™s
 = 
mod–
.
	$šã»nû
(
£qu’ûs
)

79 #C®cuÏ‹ 
loss
.

80 
loss
 = 
mod–
.
	$loss
(
log™s
, 
Ïb–s
)

82 #Bud 
a
 
G¿ph
 
th©
 
Œašs
 
the
 
mod–
 
w™h
 
Úe
 
b©ch
 
of
 
exam¶es
 
ªd


83 #upd©e 
the
 
mod–
 
·¿m‘”s
.

84 
Œaš_İ
 = 
mod–
.
	$Œaššg
(
loss
, 
glob®_¡•
)

86 #C»©
a
 
§v”
.

87 
§v”
 = 
tf
.
Œaš
.
	`Sav”
Ñf.
	`®l_v¬ŸbËs
(), 
max_to_k“p
=
FLAGS
.
num_checkpošts
)

89 #Bud 
the
 
summ¬y
 
İ”©iÚ
 
ba£d
 
Ú
h
TF
 
cŞËùiÚ
 
of
 
Summ¬›s
.

90 
summ¬y_İ
 = 
tf
.
	$m”ge_®l_summ¬›s
()

92 #Bud 
ª
 
š™Ÿliz©iÚ
 
İ”©iÚ
 
to
 
run
 
b–ow
.

93 
š™
 = 
tf
.
	$š™Ÿlize_®l_v¬ŸbËs
()

95 #S¹ 
ruÂšg
 
İ”©iÚs
 
Ú
 
the
 
G¿ph
.

96 
£ss
 = 
tf
.
	`SessiÚ
(
cÚfig
ñf.
	$CÚfigPrÙo
(
log_deviû_¶aûm’t
=

97 
FLAGS
.
log_deviû_¶aûm’t
))

98 #w™h 
tf
.
	`SessiÚ
(
cÚfig
ñf.
	`CÚfigPrÙo
(

99 #log_deviû_¶aûm’t=
FLAGS
.
log_deviû_¶aûm’t
)è
as
 
£ss
:

100 
£ss
.
	$run
(
š™
)

102 #S¹ 
the
 
queue
 
ruÂ”s
.

103 
coÜd
 = 
tf
.
Œaš
.
	$CoÜdš©Ü
()

104 
th»ads
 = 
tf
.
Œaš
.
	$¡¬t_queue_ruÂ”s
(
£ss
=£ss, 
coÜd
=coord)

106 
summ¬y_wr™”
 = 
tf
.
Œaš
.
	$Summ¬yWr™”
(
SUMMARY_DIR
, 
£ss
.
g¿ph
)

108 
Œy
:

109 
¡•
 = 1

110 
nÙ
 
coÜd
.
	$should_¡İ
():

111 
¡¬t_time
 = 
time
.
	$time
()

112 
_
, 
loss_v®ue
 = 
£ss
.
	$run
([
Œaš_İ
, 
loss
])

113 
du¿tiÚ
 = 
time
.
	`time
(è- 
¡¬t_time


115 
as£¹
 
nÙ
 
Å
.
	`i¢ª
(

116 
loss_v®ue
), 'Model diverged with†oss = NaN'

117 #£qu’û, 
Ïb–
 = 
tf
.
	`SessiÚ
().
	`run
(
£qu’û
,†abel)

118 #´št("§m¶ÏbË:", 
l
)

119 #´št("Ïb–y³:", 
l
.
dty³
)

120 #´št("Ïb– sh­e:", 
l
.
sh­e
)

121 #´št("§m¶£qu’û:", 
s
)

122 #´št("£qu’ûy³:", 
s
.
dty³
)

123 #´št("£qu’û sh­e:", 
s
.
sh­e
)

124 #´št("loss:", 
lo
)

126 #´šˆ
cu¼’t
 
¡©e


127 
¡•
 % 
FLAGS
.
´št_¡•
 == 0:

128 
num_exam¶es_³r_¡•
 = 
FLAGS
.
mšib©ch_size


129 
exam¶es_³r_£c
 = 
num_exam¶es_³r_¡•
 / 
du¿tiÚ


130 
£c_³r_b©ch
 = (
du¿tiÚ
)

132 
fÜm©_¡r
 = (

135 
	`´št
(
fÜm©_¡r
 % (
d©‘ime
.
	`now
(), 
¡•
, 
loss_v®ue
,

136 
exam¶es_³r_£c
, 
£c_³r_b©ch
))

138 #§v
summ¬y


139 
¡•
 % 
FLAGS
.
summ¬y_¡•
 == 0:

140 
summ¬y_¡r
 = 
£ss
.
	$run
(
summ¬y_İ
)

141 
summ¬y_wr™”
.
	$add_summ¬y
(
summ¬y_¡r
, 
¡•
)

142 
	`´št
("¡•: {}, wrÙsumm¬›s.".
	$fÜm©
(
¡•
))

144 #Sav
the
 
mod–
 
checkpošt
 
³riodiÿÎy
.

145 
¡•
 % 
FLAGS
.
checkpošt_¡•
 =ğ0 
	`Ü
 (

146 
¡•
 + 1è=ğ
FLAGS
.
max_¡•s
:

147 
§v”_·th
 = 
§v”
.
	$§ve
(
£ss
,

148 
CHECKPOINT_PATH
,

149 
glob®_¡•
=
¡•
)

150 
	`´št
("\nSaved mod– checkpošˆtØ{}\n".
	$fÜm©
(

151 
§v”_·th
))

152 #¡¬ˆ
ev®u©iÚ
 
this
 
checkpošt


154 
¡•
 += 1

155 
time
.
	$¦“p
(1)

157 
exû±
 
tf
.
”rÜs
.
OutOfRªgeE¼Ü
:

158 
	`´št
("Done~")

159 
fš®ly
:

160 
coÜd
.
	$»que¡_¡İ
()

161 
coÜd
.
	$još
(
th»ads
)

162 
£ss
.
	$şo£
()

165 
def
 
	$maš
(
¬gv
=
NÚe
):

166 
	`´št
("start of main")

167 
	`´št
("\nParameters:")

168 #weœd 
bug
: 
add
 
this
 
to
 
’abË
 
´št
 
®l
 
P¬am‘”s
.

169 #FLAGS.
mšib©ch_size


170 
©Œ
, 
v®ue
 
š
 
	`sÜ‹d
(
FLAGS
.
__æags
.
	$™”™ems
()):

171 
	`´št
("{}={}".
	`fÜm©
(
©Œ
.
	`uµ”
(), 
v®ue
))

172 
	`´št
("")

174 
FLAGS
.
d©a£t
 == "rotten":

175 
mod–
.
NUM_CLASSES
 = 2

176 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 8530

177 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 2132

178 
–if
 
FLAGS
.
d©a£t
 == "ag":

179 
mod–
.
NUM_CLASSES
 = 4

180 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 0

181 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 0

182 
–if
 
FLAGS
.
d©a£t
 == "newsgroups":

183 
mod–
.
NUM_CLASSES
 = 4

184 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 0

185 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 0

186 
–if
 
FLAGS
.
d©a£t
 == "imdb":

187 
mod–
.
NUM_CLASSES
 = 2

188 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_TRAIN
 = 0

189 
mod–
.
NUM_EXAMPLES_PER_EPOCH_FOR_EVAL
 = 0

191 
	`´št
("wrong dataset")

192 #mod–.
	`š™Ÿl_d©a£t_šfo
(
FLAGS
.
d©a£t
)

194 
nÙ
 
tf
.
gfe
.
	$Exi¡s
(
TRAIN_DIR
):

195 
tf
.
gfe
.
	$MakeDœs
(
TRAIN_DIR
)

196 
	`´št
("\nWr™šgØ{}\n".
	$fÜm©
(
TRAIN_DIR
))

198 
nÙ
 
tf
.
gfe
.
	$Exi¡s
(
CHECKPOINT_DIR
):

199 
tf
.
gfe
.
	$MakeDœs
(
CHECKPOINT_DIR
)

201 
	$Œaš
()

203 
	`´št
("\nƒnd of main")

206 
__Çme__
 == '__main__':

207 
tf
.
­p
.
	`run
()

	@convert_data.py

2 
äom
 
__futu»__
 
impÜt
 
absŞu‹_impÜt


3 
äom
 
__futu»__
 
impÜt
 
divisiÚ


4 
äom
 
__futu»__
 
impÜt
 
´št_funùiÚ


6 
impÜt
 
rfe


7 
impÜt
 
u¾lib


8 
impÜt
 
	gxml
.
	g‘»e
.
EËm’tT»e
 
as
 
ET


9 
impÜt
 
¿ndom


10 
impÜt
 
bz2


11 
impÜt
 
cŞËùiÚs


12 
impÜt
 
os


13 
impÜt
 
numpy
 
as
 
Å


14 
impÜt
 
‹nsÜæow
 
as
 
tf


16 
	gFLAGS
 = 
tf
.
­p
.
æags
.
FLAGS


17 
tf
.
­p
.
æags
.
DEFINE_¡ršg
(

20 
	gtf
.
	g­p
.
	gæags
.
DEFINE_¡ršg
('datasets_dir', 'datasets',

23 
	gtf
.
	g­p
.
	gæags
.
DEFINE_¡ršg
(

26 
	gtf
.
	g­p
.
	gæags
.
DEFINE_æßt
(

29 
	gtf
.
	g­p
.
	gæags
.
DEFINE_š‹g”
(

32 
	gtf
.
	g­p
.
	gæags
.
DEFINE_æßt
("dropout_keep_prob", 0.5,

35 #d©a£t 
v¬ŸbËs


37 
	gROTTEN_SOURCE
 = "rt-polaritydata"

38 
ROTTEN_DOWNLOADED
 = "rt-polaritydata.tar.gz"

39 
ROTTEN_URL
 = "http://www.cs.cornell.edu/people/pabo/movie-review-data/rt-polaritydata.tar.gz"

40 
AG_SOURCE
 = "newsspace200.xml"

41 
AG_DOWNLOADED
 = "newsspace200.xml.bz"

42 
AG_URL
 = "http://www.di.unipi.it/~gulli/newsspace200.xml.bz"

43 
NEWSGROUPS_SOURCE
 = "20news-bydate"

44 
NEWSGROUPS_DOWNLOADED
 = "20news-bydate.tar.gz"

45 
NEWSGROUPS_URL
 = "http://qwone.com/~jason/20Newsgroups/20news-bydate.tar.gz"

46 
IMDB_SOURCE
 = "aclImdb"

47 
IMDB_DOWNLOADED
 = "aclImdb_v1.tar.gz"

48 
IMDB_URL
 = "http://ai.stanford.edu/~amaas/data/sentiment/aclImdb_v1.tar.gz"

50 #Úly 
ÿ‹gÜ›s
 
š
 
this
 
li¡
 
wl
 
be
 
cÚsid”ed


51 
AG_CATEGORIES
 = ["World", "Sports", "Entertainment", "Business"]

52 #numb” 
of
 
™ems
 
—ch
 
ÿ‹gÜy


53 
	gAG_CATEGORIES_NUM
 = 40000

57 #m©
»£¬ch”s
 
£t
 
the
 
»cÜd
 
¡¿ight
.', 1), ('
ProEnglish
, 
a
 
ÇtiÚ®
 
Ügªiz©iÚ
 
th©
 
wªts
 
to
 
make
 
English
h
officŸl
 
Ïnguage
 
of
 
US
 
gov”


58 #nm’ˆ
İ”©iÚs
, 
is
 
sušg
 
the
 
D•¬tm’t
 
of
 
H—Éh
 
ªd
 
Humª
 
S”viûs
 
ov”
 
a
 ', 1), ('5', 106), ('
Music
 
F“ds
', 1207), ('
ToÚs
', 2150), ('
Soáw¬


59 #
ªd
 
Dev–İem’t
', 2739), (NÚe, 11904), ('
U
.
S
.', 13770), ('
IlŸ
', 13814), ('
H—Éh
', 19915), ('
Eurİe
', 30905), ('
Tİ
 
News
', 31917), ('
Sci
/
Te


60 #ch', 41194), ('
Tİ
 
StÜ›s
', 56045), ('
Busšess
', 56656), ('
SpÜts
', 62163), ('
EÁ”šm’t
', 70892), ('
WÜld
', 81456)]

63 
	gNEWSGROUPS_DICT
 = {"comp.graphics": "comp",

78 
NEWSGROUPS_CATEGORIES
 = 
li¡
(
£t
(
NEWSGROUPS_DICT
.
	$™”v®ues
()))

80 
IMDB_CATEGORIES
 = ["neg", "pos"]

82 #mod– 
v¬ŸbËs


84 
®phab‘
 = 
r
"abcdefghijklmnopqrstuvwxyz0123456789-,;.!?:'\"/\\|_@#$%^&*~`+-=<>()[]{}"

85 
‹¡_¿tio
 = 0.20

86 
MIN_SEQU_LENGTH
 = 20

89 
def
 
	$maybe_dowÆßd
(
d©a_dœ
, 
sourû_Çme
, 
sourû_dowÆßded
, 
sourû_u¾
):

91 
nÙ
 
tf
.
gfe
.
	$Exi¡s
(
d©a_dœ
):

92 
tf
.
gfe
.
	$MakeDœs
(
d©a_dœ
)

93 
sourû_·th
 = 
os
.
·th
.
	$još
(
d©a_dœ
, 
sourû_Çme
)

94 
	`´št
("sourû…©h:", 
sourû_·th
)

95 
nÙ
 
tf
.
gfe
.
	$Exi¡s
(
sourû_·th
):

96 
dowÆßd_·th
 = 
os
.
·th
.
	$još
(
d©a_dœ
, 
sourû_dowÆßded
)

97 
	`´št
("dowÆßdšg", 
dowÆßd_·th
, "...")

98 
dowÆßd_·th
, 
_
 = 
u¾lib
.
	$u¾»Œ›ve
(
sourû_u¾
, 
dowÆßd_·th
)

99 
w™h
 
tf
.
gfe
.
	$GFe
(
dowÆßd_·th
è
as
 
p
:

100 
size
 = 
p
.
Size


101 
	`´št
('SucûssfuÎy dowÆßded', 
dowÆßd_·th
, 
size
, 'bytes.')

102 
	`´št
("exŒaùšg", 
dowÆßd_·th
, "...")

103 
dowÆßd_·th
.
	`’dsw™h
(".tar.gz"):

104 
w™h
 
rfe
.
	`İ’
(
dowÆßd_·th
, "r:*"è
as
 
f
:

105 
f
.
	$exŒaù®l
(
d©a_dœ
)

106 
	`´št
("successfullyƒxtracted file")

107 
	`–if
 (
dowÆßd_·th
.
	`’dsw™h
(".bz")):

108 
bzfe
 = 
bz2
.
	$BZ2Fe
(
dowÆßd_·th
)

109 
d©a
 = 
bzfe
.
	$»ad
()

110 
w™h
 
	`İ’
(
sourû_·th
, "w"è
as
 
Ãw_sourû
:

111 
Ãw_sourû
.
	$wr™e
(
d©a
)

112 
	`´št
("successfullyƒxtracted file")

114 
	`´št
("unknown compressed file")

116 
	`´št
("d©a£ˆ®»adyƒxi¡s:", 
sourû_·th
)

117  
sourû_·th


120 
def
 
	$ü—‹_Úe_hÙ_veùÜ
(
ÿt
, 
ÿ‹gÜ›s
):

122 
you
 
ÿÎ
 
this
 
to
 
ü—‹
 
Ïb–s
, 
¶—£
 
make
 
su»
 
ÿt
 
is
 
š
 
ÿ‹gÜ›s
 !!!

123 
ÿt
 
is
 
š
 
ÿ‹gÜ›s
. 
C»©e
 
Úe
-
hÙ
 
veùÜ
 cat.

124 
¬gv
:

125 
ÿt
: 
¡r
 
Ü
 

126 
ÿ‹gÜ›s
: [
¡r
] 
Ü
 str

128 
Úe
-
hÛ
 
veùÜ


130 
»t
 = [0] * 
	$Ën
(
ÿ‹gÜ›s
)

131 #ià
ÿt
 
is
 
nÙ
 
found
, 
®l
 
z”o
 
veùÜ
 
wl
 
be
 
»tuºed
.

132 
Œy
:

133 
i
 = 
ÿ‹gÜ›s
.
	$šdex
(
ÿt
)

134 
i
 >= 0:

135 
»t
[
i
] = 1

136 
exû±
 
V®ueE¼Ü
:

137 
·ss


138  
»t


141 
def
 
	`shufæe_d©a
(
x
, 
y
, 
£ed
=-1):

143 
	`´št
("shuffling data...")

144 
£ed
 < 0:

145 
£ed
 = 
¿ndom
.
	$¿ndom
()

146 
¿ndom
.
	$shufæe
(
x
, 
Ïmbda
: 
£ed
)

147 
¿ndom
.
	$shufæe
(
y
, 
Ïmbda
: 
£ed
)

149  [
x
, 
y
]

152 
def
 
	`shufæe_ªd_¥l™
(
x
, 
y
, 
‹¡_¿tio
=0.2, 
£ed
=-1):

153 
	`´št
("shuffling‡nd splitting data...")

154 
	$shufæe_d©a
(
x
, 
y
, 
£ed
)

155 
d–im™”
 = (
	`Ën
(
y
è* 
‹¡_¿tio
 * -1)

156 
x_Œaš
, 
x_‹¡
 = 
x
[:
d–im™”
], x[delimiter:]

157 
y_Œaš
, 
y_‹¡
 = 
y
[:
d–im™”
], y[delimiter:]

159  [
x_Œaš
, 
y_Œaš
, 
x_‹¡
, 
y_‹¡
]

162 
def
 
	$g¿b_d©a_äom_fŞd”
(
sourû_·th
,

163 
£Ëùed_fŞd”s
,

164 
¡r_f‹r
=
Ïmbda
 
x
: x,

165 
fŞd”_m­
=
Ïmbda
 
x
: x):

167 
—ch
 
£qu’û
 
is
 
šd•’d’t
 
fe
 
¡Üed
 
und”
 
™s
 
ÿ‹gÜy
 
fŞd”
.

168 
¬gv
:

169 
sourû_·th
: 
¡r


170 
£Ëùed_fŞd”s
: [
¡r
]

171 
¡r_f‹r
: 
funùiÚ
: 
»move
 
»dundªt
 
wÜd
 
š
 
a
 
£qu’û


172 
fŞd”_m­
: 
m­
 
fŞd”
 
Çme
 
to
 
ÿ‹gÜy
‚ame,  
NÚe
 
no
 
cÜ»¥Údšg
 
ÿt
.

174 [
£qu’ûs
, 
Ïb–s
]

176 
£qu’ûs
 = []

177 
Ïb–s
 = []

179 
fŞd”
 
š
 
os
.
	$li¡dœ
(
sourû_·th
):

180 
fŞd”_·th
 = 
os
.
·th
.
	$još
(
sourû_·th
, 
fŞd”
)

181 
fŞd”_ÿt
 = 
	$fŞd”_m­
(
fŞd”
)

182 
os
.
·th
.
	$isdœ
(

183 
fŞd”_·th
è
ªd
 
fŞd”_ÿt
 
is
 
nÙ
 
NÚe
‡nd fŞd”_ÿˆ
š
 
£Ëùed_fŞd”s
:

184 
âame
 
š
 
os
.
	$li¡dœ
(
fŞd”_·th
):

185 
fe_·th
 = 
os
.
·th
.
	$još
(
fŞd”_·th
, 
âame
)

186 
os
.
·th
.
	$isfe
(
fe_·th
):

187 
w™h
 
	$İ’
(
fe_·th
è
as
 
f
:

188 
£qu’û
 = 
f
.
	$»ad
()

189 
	`Ën
(
£qu’û
è> 
MIN_SEQU_LENGTH
:

190 
£qu’û
 = 
	$¡r_f‹r
(
£qu’û
)

191 
£qu’ûs
.
	$­³nd
(
£qu’û
)

192 
Ïb–s
.
	`­³nd
(
	$ü—‹_Úe_hÙ_veùÜ
(

193 
fŞd”_ÿt
, 
£Ëùed_fŞd”s
))

195  [
£qu’ûs
, 
Ïb–s
]

198 
def
 
	$g¿b_d©a_ag
(
sourû_·th
):

199 
£qu’ûs
 = []

200 
Ïb–s
 = []

201 #numb” 
of
 
£qu’ûs
 
—ch
 
ÿ‹gÜy


202 
couÁ
 = 
	`diù
(
	`z
(
AG_CATEGORIES
, [0] * 
	$Ën
(
AG_CATEGORIES
)))

203 
w™h
 
	$İ’
(
sourû_·th
è
as
 
f
:

204 
lšes
 = 
f
.
	$»adlšes
()

205 #—ch 
lše
 
cÚšs
 
Úe
 
£qu’û


206 
lše
 
š
 
lšes
:

207 
lše
.
	`¡¬tsw™h
("<source>"):

208 
Ãw
 = "<?xmÈv”siÚ=\"1.0\"?>\À <®l_Ãws>" + 
lše
 + "</all_news> "

209 #·r£ 
xml


210 
roÙ
 = 
ET
.
	$äom¡ršg
(
Ãw
)

211 
ÿt
 = 
roÙ
.
	`fšd
("ÿ‹gÜy").
‹xt


212 
ÿt
 
š
 
AG_CATEGORIES
 
ªd
 
couÁ
[ÿt] < 
AG_CATEGORIES_NUM
:

213 
t™Ë
 = 
roÙ
.
	`fšd
("t™Ë").
‹xt


214 
desc
 = 
roÙ
.
	`fšd
("desütiÚ").
‹xt


215 
t™Ë
 
ªd
 
desc
:

216 
£qu
 = 
t™Ë
 + "\n\n" + 
desc


217 
couÁ
[
ÿt
] += 1

218 
£qu’ûs
.
	$­³nd
(
£qu
)

219 
Ïb–s
.
	`­³nd
(
	$ü—‹_Úe_hÙ_veùÜ
(
ÿt
,

220 
AG_CATEGORIES
))

221 #´št(
£qu
)

223  [
£qu’ûs
, 
Ïb–s
]

226 
def
 
	$g¿b_d©a_rÙ‹n
(
sourû_·th
):

227 
pos_·th
 = 
os
.
·th
.
	`još
(
sourû_·th
, "rt-polarity.pos")

228 
Ãg_·th
 = 
os
.
·th
.
	`još
(
sourû_·th
, "rt-polarity.neg")

229 
pos™ive_exam¶es
 = 
	`li¡
(
	`İ’
(
pos_·th
).
	$»adlšes
())

230 
pos™ive_exam¶es
 = [
s
.
	$¡r
(è
s
 
š
 
pos™ive_exam¶es
]

231 
Ãg©ive_exam¶es
 = 
	`li¡
(
	`İ’
(
Ãg_·th
).
	$»adlšes
())

232 
Ãg©ive_exam¶es
 = [
s
.
	$¡r
(è
s
 
š
 
Ãg©ive_exam¶es
]

234 
£qu’ûs
 = 
pos™ive_exam¶es
 + 
Ãg©ive_exam¶es


236 #G’”©
Ïb–s


237 
pos™ive_Ïb–s
 = [[0, 1] 
_
 
š
 
pos™ive_exam¶es
]

238 
Ãg©ive_Ïb–s
 = [[1, 0] 
_
 
š
 
Ãg©ive_exam¶es
]

239 
Ïb–s
 = 
pos™ive_Ïb–s
 + 
Ãg©ive_Ïb–s


241  [
£qu’ûs
, 
Ïb–s
]

244 
def
 
	$¿w_d©a_¡©i¡ics
(
d©a_Çme
, 
£qu’ûs
, 
Ïb–s
):

245 
	`´št
("\nSti¡ic of", 
d©a_Çme
, ":")

246 
	`´št
("thnubm” oàd©¨exam¶es:", 
	$Ën
(
£qu’ûs
))

247 
	`´št
("the‡verage†ength of dataƒxamples:",

248 
	`sum
(
	$Ën
(
s
è 
š
 
£qu’ûs
è/ 
	$Ën
(
£qu’ûs
))

249 
	`´št
("the‚umber of dataƒxamples…er category:")

250 #li¡ 
is
 
unhashabË
 
ty³


251 #øğ
cŞËùiÚs
.
	`CouÁ”
(
Ïb–s
)

252 
Ïb–s_¡r
 = ['[' + ' '.
	`još
(
	$¡r
(
b
èb 
š
 
a
è+ ']' ¨š 
Ïb–s
]

253 
c
 = 
cŞËùiÚs
.
	$CouÁ”
(
Ïb–s_¡r
)

254 
key
, 
v®
 
š
 
c
.
	$™ems
():

255 
	$´št
(
key
, 
v®
)

258 
def
 
	$lßd_d©a_ªd_Ïb–s
(
d©a£t
, 
d©a_dœ
):

260  [
£qu’ûs
, 
Ïb–s
]

261 
£qu’ûs
: [
¡r
]

262 
Ïb–s
: [
Úe
-
hÙ
 
veùÜs
]

264 
x_Œaš
 = []

265 
x_‹¡
 = []

266 
y_Œaš
 = []

267 
y_‹¡
 = []

269 
d©a£t
 == "rotten":

270 
sourû_·th
 = 
	$maybe_dowÆßd
(
d©a_dœ
, 
ROTTEN_SOURCE
,

271 
ROTTEN_DOWNLOADED
, 
ROTTEN_URL
)

272 #Lßd 
d©a
 
äom
 
fes


273 
	`´št
("cu¼’ˆwÜkšg dœeùÜy:", 
os
.
	$g‘cwd
())

274 
£qu’ûs
, 
Ïb–s
 = 
	$g¿b_d©a_rÙ‹n
(
sourû_·th
)

275 
	`´št
("shuffling dataset‡nd splittingrain/test sets")

276 
x_Œaš
, 
y_Œaš
, 
x_‹¡
, 
y_‹¡
 = 
	$shufæe_ªd_¥l™
(
£qu’ûs
, 
Ïb–s
,

277 
‹¡_¿tio
)

279 
–if
 
d©a£t
 == "ag":

280 
sourû_·th
 = 
	$maybe_dowÆßd
(
d©a_dœ
, 
AG_SOURCE
, 
AG_DOWNLOADED
,

281 
AG_URL
)

283 
	`´št
("parsing xml file...(it mayake‡ minute)")

284 
£qu’ûs
, 
Ïb–s
 = 
	$g¿b_d©a_ag
(
sourû_·th
)

285 
	`´št
("§m¶£qu’û:", 
£qu’ûs
[:10])

286 
	`´št
("§m¶Ïb–s:", 
Ïb–s
[:10])

287 
	`´št
("shuffling dataset‡nd splittingrain/test sets")

288 
x_Œaš
, 
y_Œaš
, 
x_‹¡
, 
y_‹¡
 = 
	$shufæe_ªd_¥l™
(
£qu’ûs
, 
Ïb–s
,

289 
‹¡_¿tio
)

291 
–if
 
d©a£t
 == "newsgroups":

292 
sourû_·th
 = 
	$maybe_dowÆßd
(
d©a_dœ
, 
NEWSGROUPS_SOURCE
,

293 
NEWSGROUPS_DOWNLOADED
, 
NEWSGROUPS_URL
)

295 
	`´št
("loadrain set")

296 
Œaš_·th
 = 
os
.
·th
.
	`još
(
sourû_·th
, "20news-bydate-train")

297 
x_Œaš
, 
y_Œaš
 = 
	`g¿b_d©a_äom_fŞd”
(

298 
Œaš_·th
,

299 
NEWSGROUPS_CATEGORIES
,

300 
fŞd”_m­
=
Ïmbda
 
x
: 
NEWSGROUPS_DICT
.
	$g‘
(
x
))

301 
	$shufæe_d©a
(
x_Œaš
, 
y_Œaš
)

302 
	`´št
("loadest set")

303 
‹¡_·th
 = 
os
.
·th
.
	`još
(
sourû_·th
, "20news-bydate-test")

304 
x_‹¡
, 
y_‹¡
 = 
	`g¿b_d©a_äom_fŞd”
(

305 
‹¡_·th
,

306 
NEWSGROUPS_CATEGORIES
,

307 
fŞd”_m­
=
Ïmbda
 
x
: 
NEWSGROUPS_DICT
.
	$g‘
(
x
))

308 
	$shufæe_d©a
(
x_‹¡
, 
y_‹¡
)

310 
–if
 
d©a£t
 == "imdb":

311 
sourû_·th
 = 
	$maybe_dowÆßd
(
d©a_dœ
, 
IMDB_SOURCE
, 
IMDB_DOWNLOADED
,

312 
IMDB_URL
)

313 
	`´št
("loadrain set")

314 
Œaš_·th
 = 
os
.
·th
.
	`još
(
sourû_·th
, "train")

315 
x_Œaš
, 
y_Œaš
 = 
	$g¿b_d©a_äom_fŞd”
(
Œaš_·th
, 
IMDB_CATEGORIES
)

316 
	$shufæe_d©a
(
x_Œaš
, 
y_Œaš
)

317 
	`´št
("loadest set")

318 
‹¡_·th
 = 
os
.
·th
.
	`još
(
sourû_·th
, "test")

319 
x_‹¡
, 
y_‹¡
 = 
	$g¿b_d©a_äom_fŞd”
(
‹¡_·th
, 
IMDB_CATEGORIES
)

320 
	$shufæe_d©a
(
x_‹¡
, 
y_‹¡
)

323 
	`´št
("ÿÂÙ„ecognizd©a£t:", 
d©a£t
)

324 
	`´št
("example:„otten,‡g,‚ewsgroups, imdb.")

326 
	`¿w_d©a_¡©i¡ics
("Œaš s‘", 
x_Œaš
, 
y_Œaš
)

327 
	`¿w_d©a_¡©i¡ics
("‹¡ s‘", 
x_‹¡
, 
y_‹¡
)

329  [
x_Œaš
, 
y_Œaš
, 
x_‹¡
, 
y_‹¡
]

332 
def
 
	`®ign_£qu’ûs
(
£qu’ûs
, 
·ddšg_ch¬aù”
=' ', 
max_Ëngth
=-1):

334 
The
 
Ëngth
 
is
 
defšed
 
by
 
the
 
lÚge¡
 
£qu’û
 
nÙ
 
£t
.

336 
£qu’ûs
 -- [
¡r
]

337 
R‘uºs
 
·dded
 
£qu’ûs
.

339 
	`´št
("aligning sequences...")

340 
max_Ëngth
 < 0:

341 
max_Ëngth
 = 
	`max
(
	$Ën
(
x
èx 
š
 
£qu’ûs
)

342 
·dded_£qu’ûs
 = []

343 
£qu’û
 
š
 
£qu’ûs
:

344 
nÙ
 
	$isš¡ªû
(
£qu’û
, 
ba£¡ršg
):

345 
	`´št
("error:‚ot string:")

346 
	$´št
(
£qu’û
)

347 
	`´št
("\n\n")

348 
Ãw_£qu’û
 = 
£qu’û
.
	`lju¡
(
max_Ëngth
,

349 
·ddšg_ch¬aù”
)[:
max_Ëngth
]

350 
·dded_£qu’ûs
.
	$­³nd
(
Ãw_£qu’û
)

351  
·dded_£qu’ûs


353 #
#deà
	`quªtize_£qu’ûs
(
£qu’ûs
, 
®phab‘
):

355 #"""
Givšg
 
´esüibšg
 
®phab‘
, 
quªtize
 
—ch
 
ÿ¿ù”
 
usšg
 
Úe
-
hÙ
 
’codšg


356 #š 
—ch
 
£qu’û
.

358 #£qu’ûs: [
¡r
]

360 #[[[0 
Ü
 1]]]

363 #ã©u»_sizğ
	`Ën
(
®phab‘
)

365 #fÜ 
£qu’û
 
š
 
£qu’ûs
:

367 ## 
add
 
width
 
to
 
f™
 
the
 
cÚv2D
 
of
 
TF


368 #Ãw_£qu’û.
	`­³nd
([])

369 #fÜ 
ch¬aù”
 
š
 
£qu’û
.
	`low”
():

370 #Ãw_£qu’û[0].
	`­³nd
(
	`ü—‹_Úe_hÙ_veùÜ
(
ch¬aù”
, 
®phab‘
))

371 #Ãw_£qu’ûs.
	`­³nd
(
Ãw_£qu’û
)

372 #
#»tuº 
Ãw_£qu’ûs


375 
def
 
	$quªtize_£qu’ûs
(
£qu’ûs
, 
®phab‘
):

377 
š
 
—ch
 
£qu’û
.

378 
šput
:

379 
£qu’ûs
: [
¡r
]

383 
	`´št
("quantizing sequences...")

384 
Ãw_£qu’ûs
 = []

385 
£qu’û
 
š
 
£qu’ûs
:

386 
Ãw_£qu’û
 = []

387 #add 
width
 
to
 
f™
 
the
 
cÚv2D
 
of
 
TF


388 
ch¬aù”
 
š
 
£qu’û
.
	$low”
():

389 
ch¬aù”
 
š
 
®phab‘
:

390 
Ãw_£qu’û
.
	`­³nd
(
®phab‘
.
	$šdex
(
ch¬aù”
))

392 
Ãw_£qu’û
.
	`­³nd
(
	$Ën
(
®phab‘
))

393 
Ãw_£qu’ûs
.
	$­³nd
(
Ãw_£qu’û
)

395  
Ãw_£qu’ûs


397 
def
 
	$_št64_ã©u»
(
v®ue
):

398  
tf
.
Œaš
.
	`F—tu»
(
št64_li¡
ñf.Œaš.
	$IÁ64Li¡
(
v®ue
=[value]))

401 
def
 
	$_by‹s_ã©u»
(
v®ue
):

402  
tf
.
Œaš
.
	`F—tu»
(
by‹s_li¡
ñf.Œaš.
	$By‹sLi¡
(
v®ue
=[value]))

405 
def
 
	$cÚv”t_to
(
£qu’ûs
, 
Ïb–s
, 
Çme
):

407 
num_exam¶es
 = 
	$Ën
(
Ïb–s
)

408 
	`Ën
(
£qu’ûs
è!ğ
num_exam¶es
:

409 
¿i£
 
	`V®ueE¼Ü
("sequences size %d does‚ot match†abel size %d." %

410 (
£qu’ûs
.
sh­e
[0], 
num_exam¶es
))

412 
f’ame
 = 
os
.
·th
.
	`još
(
FLAGS
.
d©a£ts_dœ
,

413 
FLAGS
.
d©a£t
 +".ch¬aù”"+ '.' + 
Çme
 + '.tfrecords')

414 
	`´št
('Wr™šg', 
f’ame
)

415 
wr™”
 = 
tf
.
pythÚ_io
.
	$TFRecÜdWr™”
(
f’ame
)

416 
šdex
 
š
 
	$¿nge
(
num_exam¶es
):

417 
exam¶e
 = 
tf
.
Œaš
.
	`Exam¶e
(
ã©u»s
ñf.Œaš.
	`F—tu»s
(
ã©u»
={

418 'Ïb–': 
	`_št64_ã©u»
(
Ïb–s
[
šdex
]),

419 '£qu’û_¿w': 
	`_by‹s_ã©u»
(
£qu’ûs
[
šdex
].
	`to¡ršg
())

420 
	}
}))

421 
wr™”
.
wr™e
(
exam¶e
.
	$S”ŸlizeToSŒšg
())

424 
def
 
	$maš
(
¬gv
):

425 #G‘ 
the
 
d©a
.

426 
x_Œaš
, 
y_Œaš
, 
x_‹¡
, 
y_‹¡
 = 
	$lßd_d©a_ªd_Ïb–s
(
FLAGS
.
d©a£t
,

427 
FLAGS
.
d©a£ts_dœ
)

429 
FLAGS
.
mod–_ty³
 == 'character':

430 
x_Œaš_®Ÿn
 = 
	$®ign_£qu’ûs
(
x_Œaš
, 
max_Ëngth
=
FLAGS
.
šput_Ëngth
)

431 
x_Œaš_quª
 = 
	$quªtize_£qu’ûs
(
x_Œaš_®Ÿn
, 
®phab‘
)

432 #CÚv”ˆ
to
 
Exam¶es
 
ªd
 
wr™e
 
the
 
»suÉ
Ø
TFRecÜds
.

433 
	`cÚv”t_to
(
Å
.
	`¬¿y
(
x_Œaš_quª
, 
dty³
òp.
ušt8
), [
a
.
	$šdex
(1è
a
 
š
 
y_Œaš
], 'train')

435 
x_‹¡_®Ÿn
 = 
	$®ign_£qu’ûs
(
x_‹¡
, 
max_Ëngth
=
FLAGS
.
šput_Ëngth
)

436 
x_‹¡_quª
 = 
	$quªtize_£qu’ûs
(
x_‹¡_®Ÿn
, 
®phab‘
)

437 
	`cÚv”t_to
(
Å
.
	`¬¿y
(
x_‹¡_quª
, 
dty³
òp.
ušt8
), [
a
.
	$šdex
(1è
a
 
š
 
y_‹¡
], 'test')

439 
–if
 
FLAGS
.
mod–_ty³
 == 'embedding':

440 
	`´št
("\n\nTo be done!!!!!!\n")

442 
	`´št
 ("error: wrong model_type")

445 
__Çme__
 == '__main__':

446 
tf
.
­p
.
	`run
()

	@inputs.py

2 
YOU
 
MUST
 
run
 
cÚv”t_d©a
 
befÜe
 
ruÂšg
 
this
 (
but
 
you
 
Úly
 
Ãed
 
to


3 
run
 
™
 
Úû
).

5 
äom
 
__futu»__
 
impÜt
 
absŞu‹_impÜt


6 
äom
 
__futu»__
 
impÜt
 
divisiÚ


7 
äom
 
__futu»__
 
impÜt
 
´št_funùiÚ


9 
impÜt
 
	gos
.
·th


11 
impÜt
 
‹nsÜæow
 
as
 
	gtf


13 #Basiø
mod–
 
·¿m‘”s
 
as
 
ex‹º®
 
æags
.

14 
	gFLAGS
 = 
tf
.
­p
.
æags
.
FLAGS


15 
tf
.
­p
.
æags
.
DEFINE_¡ršg
("dataset", "rotten",

17 
	gtf
.
	g­p
.
	gæags
.
DEFINE_¡ršg
('datasets_dir', 'datasets',

20 
	gtf
.
	g­p
.
	gæags
.
DEFINE_š‹g”
(

23 
	gtf
.
	g­p
.
	gæags
.
DEFINE_š‹g”
("alphabet_length", 71,

26 #CÚ¡ªt 
u£d
 
d—lšg
 
w™h
 
the
 
fes
, 
m©ches
 
cÚv”t_to_»cÜds
.

27 
	gtäecÜd_suffix
 = '.tfrecords'

30 
def
 
	$ch¬_šdex_b©ch_to_2d_‹nsÜ
(
b©ch
, 
b©ch_size
, 
num_Ïb–s
):

31 
¥¬£_Ïb–s
 = 
tf
.
	$»sh­e
(
b©ch
, [
b©ch_size
, 1])

32 
šdiûs
 = 
tf
.
	`»sh­e
Ñf.
	`¿nge
(0, 
b©ch_size
, 1), [batch_size, 1])

33 
cÚÿ‹Ç‹d
 = 
tf
.
	$cÚÿt
(1, [
šdiûs
, 
¥¬£_Ïb–s
])

34 
cÚÿt
 = 
tf
.
	$cÚÿt
(0, [[
b©ch_size
], [
num_Ïb–s
]])

35 
ouut_sh­e
 = 
tf
.
	$»sh­e
(
cÚÿt
, [2])

36 
¥¬£_to_d’£
 = 
tf
.
	$¥¬£_to_d’£
(
cÚÿ‹Ç‹d
, 
ouut_sh­e
, 1, 0)

37  
tf
.
	$»sh­e
(
¥¬£_to_d’£
, [
b©ch_size
, 
num_Ïb–s
])

40 
def
 
	$»ad_ªd_decode
(
f’ame_queue
):

41 
»ad”
 = 
tf
.
	$TFRecÜdR—d”
()

42 
_
, 
£rŸlized_exam¶e
 = 
»ad”
.
	$»ad
(
f’ame_queue
)

43 
ã©u»s
 = 
tf
.
	`·r£_sšgË_exam¶e
(

44 
£rŸlized_exam¶e
,

45 #DeçuÉ 
¬e
 
nÙ
 
¥ecif›d
 
sšû
 
bÙh
 
keys
‡» 
»quœed
.

46 
ã©u»s
={

47 'Ïb–': 
tf
.
	`FixedL’F—tu»
(

48 [], 
tf
.
št64
),

49 '£qu’û_¿w': 
tf
.
	`FixedL’F—tu»
(

50 [], 
tf
.
¡ršg
),

51 
	}
})

52 
£qu’û
 = 
ã©u»s
['sequence_raw']

55 
s_decode
 = 
tf
.
	$decode_¿w
(
£qu’û
, 
tf
.
ušt8
)

56 
s_b©ch
 = 
tf
.
	$ÿ¡
(
s_decode
, 
tf
.
št32
)

57 
s_’code
 = 
	`ch¬_šdex_b©ch_to_2d_‹nsÜ
(
s_b©ch
, 
FLAGS
.
šput_Ëngth
,

58 
FLAGS
.
®phab‘_Ëngth
 + 1)

59 
s_ex·nd
 = 
tf
.
	$ex·nd_dims
(
s_’code
, 0)

61 #CÚv”ˆ
Ïb–
 
äom
 
a
 
sÿÏr
 
ušt8
 
‹nsÜ
 
to
 
ª
 
št32
 scalar.

62 
s_ÿ¡
 = 
tf
.
	$ÿ¡
(
s_ex·nd
, 
tf
.
æßt32
)

63 
Ïb–
 = 
tf
.
	`ÿ¡
(
ã©u»s
['Ïb–'],f.
št32
)

65  
s_ÿ¡
, 
Ïb–


68 
def
 
	$šputs_ch¬aù”
(
d©©y³
, 
b©ch_size
, 
num_•ochs
=
NÚe
, 
mš_shufæe
=1):

70 
Args
:

71 
Œaš
: 
S–eùs
 
b‘w“n
 
the
 
	$Œaššg
 (
True
è
ªd
 
	$v®id©iÚ
 (
F®£
è
d©a
.

72 
b©ch_size
: 
Numb”
 
of
 
exam¶es
 
³r
 
»tuºed
 
b©ch
.

73 
num_•ochs
: 
Numb”
 
of
 
times
 
to
 
»ad
 
the
 
šput
 
d©a
, 
Ü
 0/
NÚe
o

74 
Œaš
 
fÜev”
.

75 
R‘uºs
:

76 
A
 
	`tu¶e
 (
images
, 
Ïb–s
), 
wh”e
:

77 * 
images
 
is
 
a
 
‹nsÜ
 
w™h
 
sh­e
 [
b©ch_size
, 
mni¡
.
IMAGE_PIXELS
]

78 
š
 
the
 
¿nge
 [-0.5, 0.5].

79 * 
Ïb–s
 
is
 
ª
 
št32
 
‹nsÜ
 
w™h
 
sh­e
 [
b©ch_size
] w™h 
the
 
Œue
 
Ïb–
,

80 
a
 
numb”
 
š
 
the
 
¿nge
 [0, 
mni¡
.
NUM_CLASSES
).

81 
NÙe
 
th©
 
ª
 
tf
.
Œaš
.
QueueRuÂ”
 
is
 
added
 
to
 
the
 
g¿ph
, 
which


82 
mu¡
 
be
 
run
 
usšg
 
e
.
g
. 
tf
.
Œaš
.
	`¡¬t_queue_ruÂ”s
().

84 
f’ame
 = 
os
.
·th
.
	`ab¥©h
(os.·th.
	`još
(

85 
FLAGS
.
d©a£ts_dœ
,

86 
FLAGS
.
d©a£t
 + ".ch¬aù”" + '.' + 
d©©y³
 + 
täecÜd_suffix
))

87 
	`´št
("R—dšgƒxam¶e äom fe: {}\n".
	$fÜm©
(
f’ame
))

89 
w™h
 
tf
.
	`Çme_scİe
('inputs_character'):

90 
f’ame_queue
 = 
tf
.
Œaš
.
	$¡ršg_šput_´oduûr
(

91 [
f’ame
],

92 
num_•ochs
=num_epochs)

94 #Ev’ 
wh’
 
»adšg
 
š
 
muÉË
 
th»ads
, 
sh¬e
 
the
 
f’ame


96 
£qu’û
, 
Ïb–
 = 
	$»ad_ªd_decode
(
f’ame_queue
)

98 #Shufæ
the
 
exam¶es
 
ªd
 
cŞËù
 
them
 
što
 
b©ch_size
 
b©ches
.

99 #(
IÁ”ÇÎy
 
u£s
 
a
 
RªdomShufæeQueue
.)

100 #W
run
 
this
 
š
 
two
 
th»ads
 
to
 
avoid
 
bešg
 
a
 
bÙ’eck
.

101 
ÿ·c™y
 = 
mš_shufæe
 + 3 * 
b©ch_size


102 
£qu’ûs
, 
¥¬£_Ïb–s
 = 
tf
.
Œaš
.
	`shufæe_b©ch
(

103 [
£qu’û
, 
Ïb–
],

104 
b©ch_size
=batch_size,

105 
num_th»ads
=2,

106 
ÿ·c™y
=capacity,

107 #Ensu» 
a
 
mšimum
 
amouÁ
 
of
 
shufæšg
 oà
exam¶es
.

108 
mš_aá”_dequeue
=
mš_shufæe
)

110  
£qu’ûs
, 
¥¬£_Ïb–s


	@rcnn_character/__init__.py

	@rcnn_embedding/__init__.py

	@
1
.
1
/usr/include
8
174
cnn_character/__init__.py
cnn_character/eval.py
cnn_character/model.py
cnn_character/train.py
convert_data.py
inputs.py
rcnn_character/__init__.py
rcnn_embedding/__init__.py
